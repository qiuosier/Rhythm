{% extends "songbird/base.html" %}
{% load staticfiles %}
{% load files_filters %}

{% block content %}
<div class="container">
    {% if request.session.email %}
        <h3>Files uploaded by {{ request.session.email }}!</h3>
        <!-- File Upload Form -->
        <form action="{{ upload_url }}" method="POST">
            {% csrf_token %}
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%;">
                </div>
            </div>
            <div class="file-upload-wrap btn btn-primary btn-sm">
                <span>Upload File</span>
                <input id="file-upload-input" onchange="ajaxFormSubmit(this.form)" type="file" name="uploads" />
            </div>
        </form>
        {% else %}
        Please login to see your files.
    {% endif %}

    <div class="row">
        <form id="sample-table-form" action="" method="POST">
            {% csrf_token %}
            <input type="hidden" name="redirect-url" value="{{ request.get_full_path }}" />
            <table id="file-table" class="table table-hover table-condensed">
                <thead>
                    <tr>
                        <th><input id="check-all-checkbox" type="checkbox" value=""></th>
                        <th>File Name</th>
                        <th>Date Added</th>
                        <th>File Size</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in files %}
                    <tr>
                        <td><input type="checkbox" name="item-checkbox-{{ forloop.counter }}" value=""></td>
                        <td>{{ file.name|get_filename }}</td>
                        <td>{{ file.time }}</td>
                        <td>
                            {{ file.size }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
$(window).load(function(){
    $("#check-all-checkbox").click(function() {
        $("input[name^='item-checkbox-'").prop('checked', this.checked);
    });
});

// File Upload Script
function formSubmitSuccess () {
    location.reload(true);
}

function formUploadProgress (oEvent) {
    if (oEvent.lengthComputable) {
    var progress = parseInt(oEvent.loaded / oEvent.total * 100, 10);
        $('.progress .progress-bar').css(
            'width',
            progress + '%'
        );
        if(progress < 100){
            $('.progress .progress-bar').text(progress + '%');
        } else {
            $('.progress .progress-bar').text('Processing...');
        }
    } else {
        // Unknown file size
        $('.progress .progress-bar').text('Uploading...');
    }
}

function ajaxFormSubmit (oForm) {
    if (!oForm.action) { return; }
    var oReq = new XMLHttpRequest();
    oReq.onload = formSubmitSuccess;
    oReq.upload.onprogress = formUploadProgress;
    if (oForm.method.toUpperCase() === "POST") {
        $('.progress .progress-bar').text('Uploading...');
        oReq.open("POST", oForm.action);
        oReq.send(new FormData(oForm));
    }
    return false;
}

</script>
{% endblock %}
